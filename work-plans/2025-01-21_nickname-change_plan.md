# 부주 시스템 지원을 위한 캐릭터 중심 데이터 구조 구현 계획서

## 📋 작업 개요

**작업명**: 캐릭터 중심 부주 시스템 + 닉네임 변경 기능 구현  
**작업일**: 2025-01-21  
**작성자**: Claude  

### 목표
- **부주 시스템 완전 지원**: 하나의 캐릭터를 N명의 사용자가 플레이 가능
- **통합 점수 관리**: 부주들의 개별 점수를 합쳐서 캐릭터 통합 점수로 표시
- **중복 참여 방지**: 같은 캐릭터로 동일 보스 중복 참여 금지
- **닉네임 동기화**: 캐릭터명 변경시 모든 부주에게 자동 동기화
- **자동 마이그레이션**: 기존 데이터를 새로운 구조로 안전하게 전환

### 현재 상황 분석
- **기존 문제점**: Discord 계정별 독립적 점수 관리로 부주 개념 지원 불가
- **데이터 구조**: 길드원 중심 → 캐릭터 중심 구조로 근본적 변경 필요  
- **확장성**: 새로운 구조로 향후 길드 시스템 확장 가능

## 📊 요구사항 분석

### 핵심 요구사항
1. **캐릭터 중심 모델**: Discord 계정 ≠ 길드원, 캐릭터 = 게임 캐릭터
2. **부주 시스템**: 본주 + 부주1 + 부주2... = 하나의 캐릭터
3. **통합 점수**: 모든 부주의 점수를 합산하여 캐릭터 총점으로 표시
4. **중복 방지**: 캐릭터 단위로 보스 참여 중복 체크
5. **닉네임 동기화**: 캐릭터명 변경시 모든 연결된 계정에 반영
6. **자동 마이그레이션**: 기존 데이터를 새 구조로 무손실 전환

### 새로운 데이터 모델
```
캐릭터 (Character)
├─ 캐릭터ID (고유키)
├─ 캐릭터명 (닉네임)
├─ 총점수 (모든 부주 점수 합산)
└─ 연결된 계정들 (Accounts)
   ├─ 본주 (Discord 계정1) - 권한: 관리자
   ├─ 부주1 (Discord 계정2) - 권한: 일반길드원
   └─ 부주2 (Discord 계정3) - 권한: 운영진
```

### 기술적 혁신
- **점수 통합**: 개별 계정 점수 → 캐릭터 통합 점수
- **중복 방지**: 사용자ID 체크 → 캐릭터ID 체크
- **권한 독립**: 각 부주가 독립적인 권한 보유

## 🔧 상세 구현 계획

### Phase 1: 새로운 데이터 구조 구축

#### 1.1 시트 구조 정의 (`src/config/constants.js`)
```javascript
SHEET_NAMES: {
  // 새로운 부주 지원 시트들
  CHARACTERS: '보탐봇-캐릭터정보',
  ACCOUNTS: '보탐봇-계정정보', 
  PARTICIPATIONS: '보탐봇-참여이력',
  
  // 기존 시트들 (유지)
  BOSS_INFO: '보탐봇-보스정보',
  LOOT_HISTORY: '보탐봇-루팅이력',
  
  // 레거시 백업
  MEMBERS_LEGACY: '보탐봇-길드원정보_백업',
}
```

#### 1.2 시트 헤더 정의
```javascript
// 캐릭터정보 시트
['캐릭터ID', '캐릭터명', '총점수', '생성일시', '수정일시']

// 계정정보 시트  
['사용자ID', '캐릭터ID', '권한', '계정유형', '가입일시']

// 참여이력 시트
['참여일시', '캐릭터ID', '실제참여자ID', '보스명', '획득점수']
```

### Phase 2: 마이그레이션 시스템 (`src/services/googleSheetsService.js`)

#### 2.1 자동 마이그레이션 로직
```javascript
async migrateToNewStructure() {
  // Step 1: 기존 데이터 백업
  await this.backupLegacyData();
  
  // Step 2: 새로운 시트 생성
  await this.createNewSheetStructure();
  
  // Step 3: 데이터 변환
  // 닉네임별 그룹핑 → 캐릭터 생성
  // 각 사용자 → 계정 정보로 변환
  // 참여이력 → 캐릭터ID 기반으로 변환
  
  // Step 4: 검증 및 완료
}
```

#### 2.2 중복 닉네임 처리
- 동일 닉네임 사용자들을 하나의 캐릭터로 그룹핑
- 권한이 가장 높은 계정을 본주로 설정
- 나머지를 부주1, 부주2... 순서로 설정

### Phase 3: 캐릭터 서비스 (`src/services/characterService.js`)

#### 3.1 핵심 기능
```javascript
// 캐릭터 관리
async getCharacterByUserId(userId)
async updateCharacterName(characterId, newName)
async addAccountToCharacter(characterId, userId, permission)

// 점수 관리  
async getCharacterTotalScore(characterId)
async addParticipation(characterId, userId, bossName, score)

// 중복 방지
async checkDuplicateParticipation(characterId, bossName, date)
```

### Phase 4: 명령어 구현/수정

#### 4.1 닉네임 변경 (`src/commands/text/user/nicknameChange.js`)
```javascript
async execute(message, args) {
  // 1. 입력 검증
  // 2. 사용자의 캐릭터 조회
  // 3. 캐릭터명 변경
  // 4. 모든 부주에게 변경사항 반영
}
```

#### 4.2 기존 명령어 수정
- `!내정보`: 캐릭터 기반 정보 표시
- 점수보기 버튼: 캐릭터 통합 점수 표시
- 보스 참여: 캐릭터 기반 중복 체크

### 3. 도움말 업데이트 (`src/commands/text/user/help.js`)

```javascript
// 일반 사용자 명령어에 추가
'• `!닉네임변경 <새닉네임>` - 자신의 닉네임 변경'
```

### 4. 닉네임 변경 이력 관리 (선택사항)

#### 새로운 시트 추가 고려사항
- **닉네임변경이력 시트**: `변경일시`, `사용자ID`, `이전닉네임`, `새닉네임`
- 관리자가 변경 이력을 추적할 수 있도록 지원

## 📁 파일 변경 사항

### 새로 생성할 파일
- `src/commands/text/user/nicknameChange.js` - 닉네임 변경 명령어

### 수정할 파일
- `src/services/googleSheetsService.js` - 닉네임 업데이트 메서드 추가
- `src/commands/text/user/help.js` - 명령어 목록에 추가

### 선택적 수정 파일
- `src/config/constants.js` - 닉네임 관련 상수 추가 (길이 제한 등)

## ⚡ 구현 우선순위

### Phase 1: 기본 기능 (필수)
1. ✅ 닉네임 변경 명령어 구현
2. ✅ Google Sheets 연동
3. ✅ 기본 검증 로직
4. ✅ 도움말 업데이트

### Phase 2: 고도화 (선택)
1. 닉네임 변경 이력 추적
2. 관리자용 닉네임 조회 기능
3. 닉네임 금지어 필터

## 🔒 보안 고려사항

### 입력 검증
- **XSS 방지**: HTML/스크립트 태그 필터링
- **길이 제한**: 최소 2자, 최대 20자
- **특수문자**: 기본적인 한글/영문/숫자/공백만 허용

### 권한 관리
- **본인 확인**: 자신의 닉네임만 변경 가능
- **쿨다운**: 10초 쿨다운으로 스팸 방지
- **시트 권한**: 등록된 사용자만 변경 가능

## 🧪 테스트 계획

### 단위 테스트
- `updateMemberNickname()` 메서드 테스트
- 닉네임 검증 로직 테스트

### 통합 테스트
- 명령어 전체 플로우 테스트
- Google Sheets 연동 테스트

### 수동 테스트 시나리오
1. **정상 케이스**: `!닉네임변경 새닉네임`
2. **중복 닉네임**: 다른 사용자와 같은 닉네임 설정
3. **에러 케이스**: 미등록 사용자, 빈 닉네임, 너무 긴 닉네임
4. **권한 확인**: 시트 미등록 사용자 접근 차단

## ⏱ 예상 작업 시간

- **Phase 1 구현**: 2-3시간
  - 명령어 구현: 1시간
  - Google Sheets 연동: 1시간  
  - 테스트 및 디버깅: 1시간

- **Phase 2 고도화**: 1-2시간 (선택사항)

총 **3-5시간** 예상

## 📝 완료 기준

### 필수 완료 기준
- [ ] `!닉네임변경 <새닉네임>` 명령어 정상 동작
- [ ] Google Sheets 길드원정보 시트 닉네임 업데이트 확인
- [ ] 동일 닉네임 중복 사용 허용 확인
- [ ] 참여 이력 점수 추적 연속성 확인 (기존 기능 영향 없음)
- [ ] 도움말에 새 명령어 추가
- [ ] 에러 처리 및 사용자 친화적 메시지

### 검증 방법
1. 테스트 서버에서 명령어 실행
2. Google Sheets에서 닉네임 변경 확인
3. 기존 참여 이력이 사용자ID로 정상 추적되는지 확인
4. 여러 사용자가 동일 닉네임 사용 가능한지 확인

---

## 🤝 승인 대기

이 작업 계획서를 검토해주세요. 추가 요구사항이나 수정사항이 있으시면 알려주세요.

**승인 후 바로 구현을 시작하겠습니다!** 🚀
