# CLAUDE.md

## 🚨 AI 세션 시작 필수 체크

**새로운 AI 도구로 작업을 시작할 때마다 반드시 먼저 실행:**
```bash
./.ai-context/status.sh
```

**그 다음 순서대로 읽기:**
1. `.ai-context/current-work.md` - 현재 작업 상황 (가장 중요!)
2. `.ai-context/codebase-overview.md` - 전체 프로젝트 구조  
3. 이 문서 계속 읽기 - 개발 가이드

**작업 완료 후 반드시:** `.ai-context/current-work.md` 업데이트

---

이 파일은 Claude Code (claude.ai/code)가 이 저장소에서 작업할 때 참고하는 가이드라인을 제공합니다.

## 프로젝트 개요

**로드나인** 게임의 길드 관리를 위한 Discord 봇입니다. 보스 스케줄 관리, 참여도 추적, 아이템 루팅 관리 등 종합적인 길드 운영 기능을 제공합니다.

### 주요 기능
- **보스 타이머**: 고정시간/리젠시간 기반 보스 스케줄 관리
- **이벤트 관리**: 길드전 등 정기 이벤트 알림
- **참여도 시스템**: 점수 기반 길드원 활동 추적 (랭킹, 시즌제 지원)
- **음성 알림**: TTS를 통한 사전 알림 (5분전, 1분전 등)
- **아이템 관리**: 루팅 이력 및 분배 관리 (확장 예정)
- **성능 최적화**: 5분 캐싱 시스템으로 대용량 데이터 처리

### 기술 스택
- `discord.js` (v14.22.1) - Discord API 라이브러리
- `dotenv` (v17.2.2) - 환경변수 관리
- `googleapis` (v159.0.0) - Google Sheets API 연동
- `node-cron` - 스케줄링 (추가 예정)
- **TTS API** - Azure Speech Services 또는 Google Cloud TTS (추가 예정)

## 사용자 인터페이스 가이드라인

### 📋 메시지 스타일 원칙 (모든 기능 개발 시 준수)

**1. 이모티콘 사용 금지**
- ❌ `✅ 보스 추가 완료! 🎯`
- ✅ `보스 추가 완료`

**2. 간결하고 명확한 메시지**
- ❌ `✅ '베나투스' 젠타임 기반 컷타임 설정 완료!\n🎯 젠타임: 09월 21일 14:39\n⏰ 컷타임: 2025-09-21 10:39:00\n📊 리젠시간: 4시간마다`
- ✅ `베나투스 젠타임 업데이트 완료. 09월 21일 14:39`

**3. 사용자 친화적인 언어**
- 기술적 용어보다는 사용자가 이해하기 쉬운 표현 사용
- 핵심 정보만 간단명료하게 전달
- 불필요한 장식이나 부가 정보 제거

**4. 일관된 메시지 패턴**
```
성공: "{대상} {작업} 완료. {핵심정보}"
오류: "{문제상황}. {해결방법}"
안내: "{상황설명}"
```

**5. 예시 적용**
```
✅ 기존: "✅ '보스명' 컷타임이 2025-09-21 14:30:00로 설정되었습니다."
✅ 개선: "보스명 컷타임 업데이트 완료. 09월 21일 14:30"

✅ 기존: "❌ 시트에 등록되지 않은 사용자입니다. 관리자에게 문의해주세요."
✅ 개선: "시트에 등록되지 않은 사용자입니다. 관리자에게 문의해주세요."
```

## 시스템 아키텍처

### 도메인 모델
```
길드 (Guild) 
├── 보스 정보 (Boss Data)
│   ├── 고정 스케줄 (매주 화,목 16:30)
│   └── 리젠 스케줄 (처치 후 N시간)
├── 이벤트 정보 (Event Data) 
│   └── 길드전 등 정기 이벤트
├── 길드원 정보 (Members)
│   ├── 권한 (관리자/일반)
│   └── 참여 점수
├── 참여 이력 (Participation History)
└── 루팅 이력 (Loot History)
```

### 폴더 구조
```
/
├── src/
│   ├── commands/
│   │   ├── text/              # !명령어 처리
│   │   │   ├── admin/         # 관리자 전용 (!보스삭제, !계정추가)
│   │   │   └── user/          # 일반 사용자 (!보스, !컷, !보스일정, !젠)
│   │   └── interactions/      # 모달, 버튼 처리
│   │       ├── modals/        # 복잡한 데이터 입력용
│   │       └── buttons/       # 컷, 참여, 참여자확인 버튼
│   ├── handlers/
│   │   ├── messageHandler.js  # !명령어 파싱 및 라우팅
│   │   └── interactionHandler.js  # 모달/버튼 라우팅
│   ├── services/              # 비즈니스 로직
│   │   ├── bossService.js     # 보스 데이터 관리
│   │   ├── bossScheduleService.js # 보스 스케줄 계산
│   │   ├── schedulerService.js # 자동 알림 스케줄러
│   │   ├── characterService.js # 캐릭터 데이터 관리
│   │   └── googleSheetsService.js # 데이터 저장
│   ├── utils/
│   │   ├── scheduler.js       # 스케줄 관리
│   │   ├── permissions.js     # 권한 체크
│   │   ├── messageParser.js   # 명령어 파싱
│   │   ├── timeCalculator.js  # 시간 계산 공통 함수
│   │   └── validator.js       # 입력 검증
│   ├── events/
│   │   ├── messageCreate.js   # 텍스트 명령어 처리
│   │   └── interactionCreate.js  # 모달/버튼 처리
│   └── config/
│       └── constants.js       # 상수 정의
├── data/                      # 로컬 캐시
└── index.js                   # 메인 파일
```

## 명령어 시스템

### 텍스트 명령어 (Prefix: `!`)
**일반 사용자:**
- `!명령어` - 사용 가능한 모든 명령어 확인
- `!내정보` - 내 캐릭터 정보 확인 (권한, 점수 등)
- `!닉네임변경 <새닉네임>` - 캐릭터명 변경 (부주 동기화)
- `!보스목록` (`!보스`) - 등록된 보스 목록 확인
- `!보스정보 <보스명>` - 특정 보스의 상세 정보 확인
- `!보스일정` - 보스 리젠 일정 확인
- `!점수` - 길드원 참여 점수 랭킹 확인 (5분 캐시, 시즌제 지원)
- `!젠 <보스명> <젠타임>` - 젠타임 기반 컷타임 역산 (시간마다 리젠 보스만)

**운영진 이상:**
- `!보스추가` (`!보스등록`) - 새로운 보스 등록 (모달 인터페이스)
- `!컷 <보스명> [시간]` - 보스 컷타임 등록 (!컷, !컷 HHMM, !컷 MMDDHHMM)
- `!점검 <완료시간>` - 점검 후 보스 젠타임 일괄 조정 (!점검 MMDDHHMM)
- `!시즌시작 <날짜>` - 점수 집계 시작일 설정 (!시즌시작 20240921)

**관리자 전용:**
- `!시트연결확인` - Google Sheets 연결 상태 확인
- `!시트생성` - 봇 전용 시트 생성
- `!시트동기화` - 시트 구조 최신화 + 모든 데이터 구조 문제 자동 해결
- `!보스삭제 <보스명>` - 등록된 보스 삭제
- `!계정추가 @사용자 [캐릭터명] [권한]` - 길드원 추가 (멘션 방식)
- `!운영진가이드` - 수동 캐릭터 추가 가이드
- `!캐시초기화` - 점수 랭킹 캐시 초기화 (!점수 명령어 문제 해결용)
- `!참여제한설정 <분>` - 보스 참여 제한 시간 설정 (0-60분)
- `!점검모드설정 <on|off>` - 점검모드 활성화/비활성화 설정

### 인터랙션 시스템
- **모달**: 복잡한 데이터 입력 (보스 추가/수정)
- **버튼**: 참여 확인, 알림 설정 등

## Google Sheets 데이터 구조

### Sheet 구성
1. **보스정보** - 보스명, 점수, 리젠타입, 리젠설정, 스케줄노출여부, 컷타임
2. **길드원정보** - 사용자ID, 닉네임, 총점수, 권한, 가입일시 (레거시)
3. **캐릭터정보** - 캐릭터명, 총점수, 생성일시, 수정일시 (새 구조)
4. **계정정보** - 사용자ID, 디스코드닉네임, 디스코드태그, 캐릭터명, 권한, 계정유형, 가입일시
5. **참여이력** - 참여일시, 캐릭터명, 실제참여자ID, 보스명, 획득점수
6. **루팅이력** - 루팅일시, 보스명, 아이템명, 획득자, 분배일시
7. **설정** - 참여제한(분), 점검모드_활성화여부, 점수_집계_시작일 등 시스템 설정

## 개발 환경 설정

### 환경변수 (.env)
```
# Discord 봇 설정
DISCORD_TOKEN=your_discord_bot_token
GUILD_ID=your_discord_server_id
COMMAND_PREFIX=!

# Google Sheets 설정
GOOGLE_SHEET_ID=your_spreadsheet_id
GOOGLE_SERVICE_ACCOUNT_PATH=./service-account-key.json

# 개발 환경 설정
NODE_ENV=development
LOG_LEVEL=info

# 시간대 설정
TZ=Asia/Seoul

# 알림 시스템 설정
NOTIFICATION_CHANNEL_ID=your_notification_channel_id_here
NOTIFICATION_ENABLED=true
```

### 개발 명령어
```bash
# 의존성 설치
npm install

# 봇 실행
node index.js

# 개발모드 (변경사항 자동 재시작)
nodemon index.js
```

## 개발 시 고려사항

### 확장성
- **멀티 길드 지원**: 복잡성이 크지 않다면 구현
- **모듈화**: 기능별 독립적인 모듈 설계
- **최신 개발 패턴**: ES6+, async/await, 에러 처리

### 성능 및 안정성
- **Discord API 레이트 리밋** 처리
- **Google Sheets API 오류** 처리 및 재시도 로직
- **정확한 스케줄링**: 한국 시간(KST) 기준
- **메모리 관리**: 50~100명 사용자 고려

### 사용자 경험
- **음성 알림**: 고품질 TTS 사용
- **직관적 UI**: 버튼, 모달 등 인터랙션 활용
- **에러 메시지**: 사용자 친화적인 한국어 메시지
- **메시지 스타일**: 이모티콘 없이 간결하고 명확한 표현

## 권한 시스템

### 권한 체크 방식
봇의 명령어는 **Google Sheets 기반**으로만 권한을 체크합니다:

- `보탐봇-길드원정보` 시트의 권한 컬럼에서 조회
- Discord 서버 관리자 권한과는 별도로 동작

### 권한 종류 (3단계 체계)
- **관리자**: 모든 시트 관리 명령어 사용 가능 (최고 권한)
- **운영진**: 운영진 전용 명령어 사용 가능 (중간 권한)
- **일반길드원**: 일반 사용자 명령어만 사용 가능

### 권한 설정 방법
Google Sheets의 `보탐봇-길드원정보` 시트에서 권한을 관리합니다:
```
사용자ID | 닉네임 | 총점수 | 권한 | 가입일시
111111   | 관리자  | 100   | 관리자 | 2024-01-01 09:00:00
123456   | 홍길동  | 50    | 운영진 | 2024-01-01 10:00:00
789012   | 김철수  | 0     | 일반길드원 | 2024-01-01 11:00:00
```

### 명령어별 권한 요구사항
**관리자 전용:**
- `!시트연결확인`: Google Sheets 연결 상태 확인
- `!시트생성`: 봇 전용 시트 생성
- `!시트동기화`: 시트 구조 최신화
- `!보스삭제`: 등록된 보스 삭제
- `!계정추가`: 길드원 추가
- `!캐시초기화`: 점수 랭킹 캐시 초기화
- `!참여제한설정`: 보스 참여 제한 시간 설정
- `!점검모드설정`: 점검모드 활성화/비활성화 설정

**운영진 이상:**
- `!보스추가`: 새로운 보스 등록 (모달 인터페이스)
- `!점검`: 점검 후 보스 젠타임 일괄 조정
- `!시즌시작`: 점수 집계 시작일 설정

**일반 사용자 (권한 체크 없음):**
- `!명령어`: 사용 가능한 명령어 목록
- `!내정보`: 개인 정보 확인 (권한, 점수 등)
- `!닉네임변경 <새닉네임>`: 캐릭터명 변경 (부주 동기화)
- `!보스목록`: 등록된 보스 목록 확인
- `!보스정보 <보스명>`: 특정 보스의 상세 정보 확인
- `!보스일정`: 보스 리젠 일정 확인 (권한 체크 제거됨)
- `!점수`: 길드원 참여 점수 랭킹 확인 (5분 캐시, 시즌제 지원)
- `!컷 <보스명> [시간]`: 보스 컷타임 등록 (권한 체크 제거됨)
- `!젠 <보스명> <젠타임>`: 젠타임 기반 컷타임 역산 (권한 체크: 시트 등록 사용자)

## 보스 알림 시스템

### 자동 알림 기능
- **5분전 알림**: 간단한 텍스트 메시지 (`베나투스 5분전`)
- **1분전 알림**: 컷 버튼이 포함된 메시지 (`베나투스 1분전` + [컷 버튼])

### 인터랙티브 기능
1. **컷 버튼**: 클릭 시 현재 시간으로 자동 컷타임 등록
2. **참여 버튼**: 컷 완료 후 표시, 클릭 시 자동 점수 적립
3. **참여자 확인**: 해당 보스 참여자 목록 조회 (개인 메시지)

### 스케줄러 시스템
- **실행 주기**: 1분마다 자동 실행
- **알림 조건**: 보스 리젠 시간 기준 5분전/1분전
- **중복 방지**: 동일 알림 중복 발송 방지 캐시 시스템
- **자동 정리**: 1시간 이상 된 캐시 자동 삭제

### 참여 관리 시스템
- **참여 기록**: Google Sheets 참여이력 시트 자동 기록
- **점수 적립**: 캐릭터 점수 자동 증가
- **중복 방지**: 동일 보스 중복 참여 차단
- **개인 피드백**: `참여완료! 점수변경: 10 + 3 = 13` 형태

### 권한 관리 파일
- **위치**: `src/utils/permissions.js`
- **주요 함수**:
  - `checkSuperAdminCommandPermission(message)`: 관리자 전용 명령어 권한 체크
  - `checkCommandPermission(message)`: 운영진 이상 명령어 권한 체크
  - `getUserPermissionFromSheet(userId)`: 시트에서 사용자 권한 조회

---
*이 문서는 개발 진행에 따라 지속적으로 업데이트됩니다.*