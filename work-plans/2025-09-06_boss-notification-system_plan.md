# 보스 알림 시스템 구현 작업 계획서

## 📋 작업 개요
- **작업명**: 보스 리젠 알림 및 참여 시스템 구현
- **작성일**: 2025-09-06  
- **담당자**: Claude Code
- **작업 유형**: 신규 기능 개발

## 🎯 목표
- 보스 리젠 5분전, 1분전 자동 알림 시스템 구현
- 1분전 알림 시 컷 버튼 제공으로 실시간 컷타임 등록
- 참여 시스템 구현으로 자동 점수 적립 기능
- 참여자 확인 기능으로 투명한 참여 관리

## 📊 요구사항 분석

### 핵심 기능
1. **스케줄러 시스템**
   - 1분마다 실행되는 백그라운드 스케줄러
   - 보스 리젠 시간 모니터링 및 알림 발송

2. **알림 시스템**  
   - **5분전 알림**: 보스명, 리젠 시간 정보만 제공
   - **1분전 알림**: 보스명, 리젠 시간 + **컷 버튼** 포함

3. **인터랙션 시스템**
   - **컷 버튼**: 클릭 시 현재 시간으로 컷타임 자동 등록
   - **버튼 변환**: 컷 버튼 → 참여/참여자확인 버튼으로 동적 변경
   - **참여 버튼**: 클릭 시 참여이력 기록 + 점수 적립
   - **참여자확인 버튼**: 참여자 목록 조회

4. **데이터 관리**
   - 참여이력 시트 자동 기록
   - 캐릭터 점수 자동 누적
   - 중복 참여 방지

## 🏗️ 구현 계획

### Phase 1: 스케줄러 인프라 구축  
**목표**: 백그라운드 스케줄링 시스템 구현
**소요시간**: 30분

**작업 내용**:
1. **스케줄러 서비스 생성**
   - `src/services/schedulerService.js` 생성
   - `node-cron` 라이브러리 사용하여 1분마다 실행
   - 보스 리젠 시간 체크 로직 구현

2. **알림 조건 확인 로직**
   - 현재 시간 기준 5분전, 1분전 보스 필터링
   - 이미 알림 발송된 보스 중복 방지 (메모리 또는 임시 저장)

3. **봇 시작 시 스케줄러 자동 실행**
   - `index.js`에서 봇 Ready 이벤트 시 스케줄러 시작

**성공 기준**:
- [ ] 스케줄러 1분마다 정상 실행 확인
- [ ] 보스 리젠 시간 계산 로직 정확성 확인  
- [ ] 중복 알림 방지 기능 동작 확인

### Phase 2: 기본 알림 시스템 구현
**목표**: 5분전, 1분전 Discord 메시지 알림
**소요시간**: 25분

**작업 내용**:
1. **알림 메시지 포맷 설계**
   - **5분전**: 단순 정보성 메시지
   ```
   베나투스 5분전
   ```

   - **1분전**: 컷 버튼 포함 메시지
   ```
   베나투스 1분전
   [컷 버튼]
   ```

2. **알림 발송 로직 구현**
   - Discord 채널로 메시지 발송
   - 환경변수로 알림 채널 ID 설정

3. **에러 처리**
   - 스케줄러 실행 중 오류 시 로깅 및 복구

**성공 기준**:
- [ ] 5분전 알림 메시지 정상 발송
- [ ] 1분전 알림 메시지 + 컷 버튼 정상 표시
- [ ] 알림 발송 실패 시 에러 로깅 확인

### Phase 3: 컷 버튼 및 동적 UI 구현
**목표**: 컷 버튼 클릭 → 참여 시스템 버튼 전환
**소요시간**: 35분

**작업 내용**:
1. **컷 버튼 인터랙션 구현**
   - `src/commands/interactions/buttons/cutButton.js` 생성
   - 버튼 클릭 시 현재 시간으로 컷타임 자동 등록
   - 성공 시 버튼을 참여/참여자확인 버튼으로 교체

2. **메시지 업데이트 로직**
   - 기존 알림 메시지를 새로운 버튼으로 업데이트
   ```
   베나투스 컷 완료
   [참여] [참여자 확인]
   ```

3. **버튼 상태 관리**  
   - 보스별 컷 상태 메모리 저장 (보스명 → 컷타임 매핑)
   - 중복 컷 방지 로직

**성공 기준**:
- [ ] 컷 버튼 클릭 시 컷타임 자동 등록 확인
- [ ] 메시지 UI 동적 업데이트 확인
- [ ] 중복 컷 방지 기능 동작 확인

### Phase 4: 참여 시스템 구현
**목표**: 참여 버튼 클릭 시 점수 적립 및 이력 관리
**소요시간**: 40분

**작업 내용**:
1. **참여 버튼 인터랙션 구현**
   - `src/commands/interactions/buttons/participationButton.js` 생성
   - 버튼 클릭 시 사용자 확인 및 캐릭터 조회

2. **참여이력 데이터 처리**
   - Google Sheets 참여이력 시트에 데이터 추가
   ```
   참여일시 | 캐릭터명 | 실제참여자ID | 보스명 | 획득점수
   ```

3. **점수 적립 시스템**
   - 캐릭터정보 시트에서 기존 점수 조회
   - 보스 점수만큼 점수 증가
   - 업데이트된 점수를 시트에 반영

4. **개인 알림 메시지**
   - 참여 완료 시 개인에게만 보이는 응답 (ephemeral)
   ```
   ✅ 참여완료!
   점수변경: 10 + 3 = 13
   ```

5. **중복 참여 방지**
   - 동일 보스, 동일 컷타임에 대한 중복 참여 체크

**성공 기준**:
- [ ] 참여 버튼 클릭 시 참여이력 시트 기록 확인
- [ ] 점수 자동 적립 및 누적 확인
- [ ] 개인 알림 메시지 정상 표시 확인  
- [ ] 중복 참여 방지 기능 동작 확인

### Phase 5: 참여자 확인 시스템 구현
**목표**: 참여자 목록 조회 기능 완성
**소요시간**: 20분

**작업 내용**:
1. **참여자 확인 버튼 구현**
   - `src/commands/interactions/buttons/participantListButton.js` 생성
   - 해당 보스의 참여자 목록 조회

2. **참여자 목록 포맷팅**
   ```
   📋 베나투스 참여자 목록
   1. 홍길동 (3점 획득)
   2. 김철수 (3점 획득)
   3. 박영희 (3점 획득)
   
   총 참여자: 3명
   ```

3. **개인 알림으로 응답**
   - ephemeral 메시지로 개인에게만 표시

**성공 기준**:
- [ ] 참여자 목록 정확한 조회 확인
- [ ] 개인 알림으로 목록 표시 확인
- [ ] 참여자 수 및 획득 점수 정확성 확인

### Phase 6: 설정 및 최적화
**목표**: 시스템 안정성 및 설정 완성
**소요시간**: 20분

**작업 내용**:
1. **환경변수 설정**
   - `.env.example`에 알림 채널 ID 추가
   - 알림 활성화/비활성화 설정 추가

2. **로깅 시스템 강화**
   - 스케줄러 실행 로그
   - 알림 발송 로그  
   - 참여 처리 로그

3. **에러 복구 시스템**
   - 스케줄러 오류 시 자동 재시작
   - Discord API 오류 시 재시도 로직

4. **문서 업데이트**
   - CLAUDE.md에 알림 시스템 설명 추가
   - 사용법 가이드 업데이트

**성공 기준**:
- [ ] 환경변수 설정 완료
- [ ] 상세 로깅 시스템 동작 확인
- [ ] 에러 복구 메커니즘 테스트 통과
- [ ] 문서 업데이트 완료

## 🗂️ 파일 구조

### 새로 생성할 파일들
```
src/
├── services/
│   └── schedulerService.js        # 메인 스케줄러 서비스
├── commands/
│   └── interactions/
│       └── buttons/
│           ├── cutButton.js       # 컷 버튼 처리
│           ├── participationButton.js  # 참여 버튼 처리  
│           └── participantListButton.js # 참여자 목록 버튼 처리
└── utils/
    ├── notificationFormatter.js   # 알림 메시지 포맷팅
    └── participationManager.js    # 참여 관련 유틸리티
```

### 수정할 파일들
```
index.js                          # 스케줄러 시작 코드 추가
.env.example                      # 알림 채널 설정 추가
src/services/googleSheetsService.js  # 참여이력 처리 메서드 추가
CLAUDE.md                         # 문서 업데이트
```

## 📊 데이터베이스 스키마

### 참여이력 시트 (기존)
```
참여일시 | 캐릭터명 | 실제참여자ID | 보스명 | 획득점수
```

### 임시 메모리 저장 (알림 중복 방지)
```javascript
// 메모리 저장 예시
const notificationCache = new Map();
// 키: `${보스명}_${리젠시간}_${알림타입}`
// 값: 발송 시간
```

### 컷 상태 메모리 저장  
```javascript
// 컷 상태 저장 예시
const cutStatusCache = new Map();
// 키: `${보스명}_${컷타임}`  
// 값: { cutTime, messageId, channelId }
```

## ⚙️ 환경변수 추가

```env
# 알림 시스템 설정
NOTIFICATION_CHANNEL_ID=1234567890123456789
NOTIFICATION_ENABLED=true

# 스케줄러 설정 (선택사항)
SCHEDULER_INTERVAL=1 # 분 단위
```

## 🎯 성공 지표

### 기능 요구사항
- [ ] 5분전 알림 정확한 발송 (±30초 오차 허용)
- [ ] 1분전 알림 + 컷 버튼 정상 표시
- [ ] 컷 버튼 → 참여 버튼 전환 동작
- [ ] 참여 시 점수 정확한 적립  
- [ ] 참여자 목록 정확한 조회
- [ ] 중복 참여/알림 방지 기능

### 성능 요구사항  
- [ ] 스케줄러 24시간 안정 동작
- [ ] 버튼 응답 시간 3초 이내
- [ ] 동시 참여자 10명까지 정상 처리

### 사용자 경험
- [ ] 직관적인 버튼 UI/UX
- [ ] 명확한 피드백 메시지
- [ ] 개인정보 보호 (ephemeral 응답)

## 📅 일정
- **Phase 1**: 스케줄러 인프라 (30분)
- **Phase 2**: 기본 알림 시스템 (25분)
- **Phase 3**: 컷 버튼 및 동적 UI (35분)
- **Phase 4**: 참여 시스템 (40분)
- **Phase 5**: 참여자 확인 시스템 (20분)  
- **Phase 6**: 설정 및 최적화 (20분)
- **총 소요시간**: 170분 (약 2시간 50분)

## ⚠️ 주의사항

### 스케줄러 안정성
- 봇 재시작 시 스케줄러 자동 재개
- 메모리 누수 방지 (알림 캐시 정기 정리)

### 동시성 처리  
- 다수 사용자 동시 참여 시 데이터 무결성
- 컷 버튼 중복 클릭 방지

### 데이터 정확성
- 시간대 처리 (KST 기준 정확한 계산)
- 점수 계산 검증 로직 필수

---
*TTS 기능은 별도 작업 계획서로 후속 진행*