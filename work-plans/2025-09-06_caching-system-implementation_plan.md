# 캐싱 시스템 구현 작업 계획서

## 📋 작업 개요
- **작업명**: 메모리 캐싱 시스템 도입으로 성능 최적화
- **작성일**: 2025-09-06
- **담당자**: Claude Code
- **작업 유형**: 성능 최적화

## 🎯 목표
- 구글시트 API 호출 횟수 감소로 전체 응답 속도 향상
- 자주 조회되는 데이터의 메모리 캐싱 구현
- 캐시 무효화 전략으로 데이터 일관성 보장

## 📊 현재 상황 분석

### 성능 병목 지점
1. **보스 존재 확인**: `getBossByName()` - 평균 400ms
2. **사용자 권한 확인**: `getUserPermissionFromSheet()` - 평균 1,500ms  
3. **보스 목록 조회**: `getBossList()` - 평균 800ms
4. **구글시트 업데이트**: `updateBoss()` - 평균 1,000ms

### 캐싱 대상 선정
**높은 우선순위** (자주 조회, 변경 빈도 낮음):
- 보스 목록 (getBossList)
- 사용자 권한 정보 (getUserPermissionFromSheet)
- 보스 상세 정보 (getBossByName)

**중간 우선순위** (조회 빈도 중간):
- 캐릭터 정보 (getCharacterByUserId)

**낮은 우선순위** (자주 변경됨):
- 보스 컷타임 (실시간성 중요)

## 🏗️ 구현 계획

### Phase 1: 캐싱 인프라 구축
**목표**: 기본 캐싱 시스템 구현
**소요시간**: 30분

**작업 내용**:
1. **메모리 캐시 서비스 생성**
   - `src/services/cacheService.js` 생성
   - TTL 기반 캐시 구현 (Map 사용)
   - 캐시 생성, 조회, 삭제, 전체 삭제 기능

2. **캐시 설정 상수 정의**
   - `src/config/constants.js`에 캐시 TTL 설정 추가
   - 캐시 키 네이밍 규칙 정의

**성공 기준**:
- [ ] cacheService 클래스 구현 완료
- [ ] TTL 자동 만료 기능 동작 확인
- [ ] 캐시 CRUD 기본 기능 테스트 통과

### Phase 2: 보스 정보 캐싱 적용
**목표**: 보스 관련 API 성능 향상
**소요시간**: 20분

**작업 내용**:
1. **bossService 캐싱 적용**
   - `getBossList()`: 보스 목록 5분 캐싱
   - `getBossByName()`: 개별 보스 정보 5분 캐싱

2. **캐시 무효화 구현**
   - `addBoss()` 실행 시 보스 목록 캐시 삭제
   - `updateBoss()` 실행 시 해당 보스 캐시 삭제
   - `deleteBoss()` 실행 시 관련 캐시 삭제

**성공 기준**:
- [ ] `!보스목록` 명령어 2회째부터 즉시 응답 (< 100ms)
- [ ] `!보스정보` 명령어 캐싱 적용 확인
- [ ] 보스 정보 변경 시 캐시 무효화 동작 확인

### Phase 3: 권한 정보 캐싱 적용
**목표**: 권한 확인 성능 대폭 향상
**소요시간**: 15분

**작업 내용**:
1. **permissions.js 캐싱 적용**
   - `getUserPermissionFromSheet()`: 사용자 권한 10분 캐싱
   - 권한 변경 감지 및 캐시 무효화

2. **캐릭터 서비스 캐싱 적용**
   - `getCharacterByUserId()`: 캐릭터 정보 5분 캐싱

**성공 기준**:
- [ ] 권한이 필요한 명령어 2회째부터 권한 확인 즉시 완료
- [ ] 권한 변경 시 캐시 무효화 확인
- [ ] `!내정보` 명령어 성능 향상 확인

### Phase 4: 성능 측정 및 최적화
**목표**: 캐싱 효과 검증 및 미세 조정
**소요시간**: 15분

**작업 내용**:
1. **성능 로깅 개선**
   - 캐시 히트/미스 로깅 추가
   - 응답 시간 비교 로깅

2. **캐시 설정 최적화**
   - TTL 값 조정 (필요시)
   - 메모리 사용량 모니터링

3. **문서화**
   - 캐싱 시스템 사용법 CLAUDE.md 업데이트
   - 개발 가이드라인 업데이트

**성공 기준**:
- [ ] 전체 명령어 응답 시간 50% 이상 단축 달성
- [ ] 캐시 히트율 80% 이상 달성
- [ ] 메모리 사용량 안정성 확인

## 📈 예상 성능 향상

### 현재 성능 (캐싱 전)
- `!컷` 명령어: 2,680ms
- `!보스일정` 명령어: ~2,000ms (추정)
- `!보스목록` 명령어: ~1,500ms (추정)
- `!보스정보` 명령어: ~1,200ms (추정)

### 목표 성능 (캐싱 후)
- `!컷` 명령어: ~1,000ms (60% 단축)
- `!보스일정` 명령어: ~500ms (75% 단축)
- `!보스목록` 명령어: ~100ms (93% 단축)
- `!보스정보` 명령어: ~100ms (92% 단축)

## 🔧 기술 구현 상세

### 캐시 키 네이밍 규칙
```
boss_list_all                    # 전체 보스 목록
boss_list_visible               # 노출된 보스 목록만  
boss_detail_{보스명}            # 개별 보스 정보
user_permission_{사용자ID}      # 사용자 권한 정보
character_info_{사용자ID}       # 캐릭터 정보
```

### TTL 설정
- **보스 목록**: 5분 (300초) - 변경 빈도 낮음
- **보스 상세정보**: 5분 (300초) - 변경 빈도 낮음
- **사용자 권한**: 10분 (600초) - 매우 안정적인 데이터
- **캐릭터 정보**: 5분 (300초) - 닉네임 변경 등 가능성

### 메모리 관리
- Map 객체 사용으로 빠른 조회/삭제
- TTL 기반 자동 만료로 메모리 누수 방지
- 최대 캐시 항목 수 제한 (1000개)

## ⚠️ 주의사항

### 데이터 일관성
- 쓰기 작업 시 관련 캐시 즉시 무효화 필수
- 권한 변경 시 해당 사용자 캐시 삭제 필수

### 메모리 사용량
- 캐시 데이터 크기 모니터링
- 필요시 LRU 캐시로 전환 고려

### 동시성 처리
- 동시 요청 시 중복 API 호출 방지 (선택사항)

## 🎯 성공 지표
1. **응답 속도**: 전체 명령어 평균 50% 이상 단축
2. **API 호출 감소**: 구글시트 API 호출 70% 이상 감소
3. **사용자 경험**: 2초 이상 걸리는 명령어 1개 이하
4. **안정성**: 캐시 도입 후 24시간 무장애 운영

## 📅 일정
- **Phase 1**: 캐싱 인프라 (30분)
- **Phase 2**: 보스 정보 캐싱 (20분)  
- **Phase 3**: 권한 정보 캐싱 (15분)
- **Phase 4**: 성능 측정 및 문서화 (15분)
- **총 소요시간**: 80분

---
*작업 진행 중 이슈 발생 시 즉시 작업 계획 수정*