# 작업 로그: 부주 시스템 지원을 위한 캐릭터 중심 데이터 구조 구현

## 작업 정보
- **작업일**: 2025-01-21 16:30
- **담당자**: Claude
- **작업 유형**: 새로운 기능 구현 + 데이터 구조 개편

## 요청 사항

### 초기 요청
사용자가 본인의 정보중 닉네임을 직접 변경할 수 있는 `!닉네임변경` 기능 구현

### 확장된 요구사항 (분석 후 추가)
1. **부주 시스템 지원**: 하나의 캐릭터를 N명의 사용자가 플레이 가능
2. **통합 점수 표시**: 부주들의 점수를 합쳐서 표시
3. **중복 참여 방지**: 같은 캐릭터로 동일 보스 중복 참여 금지
4. **닉네임 동기화**: 캐릭터명 변경시 모든 부주에게 동기화
5. **시트 동기화**: 새로운 데이터 구조에 맞는 자동 마이그레이션

## 기술적 결정사항

### 데이터 구조 변경
- **기존**: Discord 계정 = 개별 길드원
- **신규**: 캐릭터 = 여러 Discord 계정이 공유하는 게임 캐릭터

### 새로운 시트 구조
1. **캐릭터정보** (`보탐봇-캐릭터정보`)
   - 캐릭터ID, 캐릭터명, 총점수, 생성일시, 수정일시

2. **계정정보** (`보탐봇-계정정보`) 
   - 사용자ID, 캐릭터ID, 권한, 계정유형, 가입일시

3. **참여이력** (`보탐봇-참여이력`)
   - 참여일시, 캐릭터ID, 실제참여자ID, 보스명, 획득점수

## 구현 계획

### Phase 1: 데이터 구조 및 마이그레이션 시스템
- [ ] `constants.js`에 새로운 시트 이름 정의
- [ ] `googleSheetsService.js`에 새로운 헤더 구조 추가
- [ ] 자동 마이그레이션 로직 구현
- [ ] 시트 동기화 시스템 업데이트

### Phase 2: 캐릭터 관리 서비스
- [ ] `characterService.js` 신규 생성
- [ ] 캐릭터 CRUD 기능 구현
- [ ] 부주 그룹 관리 기능
- [ ] 중복 참여 방지 로직

### Phase 3: 명령어 구현/수정
- [ ] `!닉네임변경` 명령어 구현
- [ ] `!내정보` 명령어 수정 (캐릭터 기반)
- [ ] 점수보기 버튼 수정 (통합 점수)
- [ ] `!도움말` 업데이트

### Phase 4: 부주 관리 명령어 (추가 기능)
- [ ] `!부주추가` 명령어 구현
- [ ] `!부주목록` 명령어 구현
- [ ] `!캐릭터이전` 명령어 구현

## 작업 진행 상황

### ✅ 완료된 작업

#### Phase 1: 데이터 구조 및 마이그레이션 시스템 ✅
- **constants.js** - 새로운 시트 구조 정의 완료
  - 캐릭터정보, 계정정보, 참여이력 시트 정의
  - 레거시 호환성 유지를 위한 별칭 설정
- **googleSheetsService.js** - 마이그레이션 시스템 구현 완료
  - 자동 구조 감지 기능
  - 레거시 → 새 구조 자동 마이그레이션
  - 데이터 백업 및 검증 시스템
  - 점진적 전환을 위한 호환성 유지

#### Phase 2: 캐릭터 관리 서비스 ✅
- **characterService.js** - 캐릭터 중심 비즈니스 로직 완성
  - 캐릭터 조회/관리 기능 (ID, 이름, 사용자 기반)
  - 캐릭터명 변경 및 동기화
  - 통합 점수 계산 및 관리
  - 참여 이력 관리 (중복 방지 포함)
  - 부주 시스템 (계정 추가/제거)
  - Discord 임베드 포맷팅

#### Phase 3: 명령어 구현/수정 ✅
- **!닉네임변경** - 새 명령어 구현 완료
  - 입력 검증 및 보안 체크
  - 중복 캐릭터명 확인 및 사용자 승인
  - 모든 부주에 자동 동기화
  - 상세한 성공/실패 응답
- **!내정보** - 캐릭터 시스템 대응 완료
  - 새/구 시스템 자동 감지
  - 마이그레이션 안내 기능
  - 캐릭터 중심 정보 표시
  - 부주 시스템 안내
- **점수보기 버튼** - 캐릭터 통합 점수 지원
  - 레거시/신규 버튼 동시 지원
  - 캐릭터 상세 점수 정보
  - 최근 참여 이력 표시
  - 부주 계정 정보 표시
- **!도움말** - 새 명령어 안내 추가

### 🔄 현재 진행 중
- 시스템 안정화 및 호환성 업데이트

### 📋 추가 완료 작업
- ✅ Discord.js v15 호환성 업데이트
  - `ready` → `clientReady` 이벤트 변경
  - `ActivityType` 사용 방식 업데이트
  - Deprecation warning 해결
- ✅ 데이터 구조 대폭 단순화
  - 캐릭터 ID 시스템 제거
  - 캐릭터명을 직접 키로 사용
  - 운영진 친화적 시트 구조로 변경
- ✅ characterService.js 전면 리팩토링
  - 캐릭터명 기반 로직으로 변경
  - createNewCharacter 메서드 추가
  - addUserToExistingCharacter 메서드 추가
- ✅ !계정추가 명령어 구현
  - Discord 멘션 기반 자동 추가
  - 새 캐릭터 생성 또는 기존 캐릭터에 부주 추가
  - 관리자 전용 명령어
  - 상세한 성공/실패 응답

### 📋 다음 작업
- 기존 명령어들을 새로운 구조에 맞게 업데이트
- 실제 시트 마이그레이션 테스트
- 전체 시스템 통합 테스트

## 예상 작업 시간
- **Phase 1**: 3-4시간 (마이그레이션 시스템 구현)
- **Phase 2**: 2-3시간 (캐릭터 서비스)
- **Phase 3**: 2-3시간 (명령어 구현/수정)
- **Phase 4**: 1-2시간 (부가 기능)

**총 예상 시간**: 8-12시간

## 주의사항
- 기존 데이터 손실 방지를 위한 백업 필수
- 점진적 전환으로 서비스 중단 최소화
- 마이그레이션 검증 과정 필수

---
*작업 로그는 진행에 따라 업데이트됩니다.*
