# 닉네임 자동 가입 시스템 구현 가이드

## 📋 개요

`!닉네임변경` 명령어를 확장하여 미등록 사용자의 자동 가입 기능을 구현했습니다. 이를 통해 운영진의 수동 계정 추가 작업 부담을 줄이고, 사용자가 직접 길드에 가입할 수 있도록 개선했습니다.

## 🎯 목적

### 기존 문제점
- 새로운 길드원이 봇 기능을 사용하려면 운영진이 수동으로 `!계정추가` 명령어 실행 필요
- 운영진 부재 시 신규 가입자가 봇 기능 사용 불가
- 운영진의 관리 부담 증가

### 해결 방안
- `!닉네임변경` 명령어에 자동 가입 로직 추가
- 미등록 사용자가 명령어 실행 시 자동으로 길드 등록
- 사용자 주도적 가입 프로세스 구현

## 🔄 변경된 동작 로직

### 기존 로직
```
!닉네임변경 <새닉네임>
├── 시트 등록 확인
├── 등록 안됨 → ❌ 에러 메시지
└── 등록됨 → 닉네임 변경 진행
```

### 새로운 로직
```
!닉네임변경 <새닉네임>
├── 캐릭터명 유효성 검사
├── 시트 등록 확인
├── 등록 안됨 → 🎉 자동 가입 처리
│   ├── 새 캐릭터 생성 (입력된 닉네임 사용)
│   ├── 기본 권한: '일반길드원'
│   └── 가입 완료 메시지 표시
└── 등록됨 → 기존 닉네임 변경 로직
```

## 📝 구현 세부사항

### 1. 자동 가입 처리 로직

**조건 확인**
```javascript
const userPermission = await getUserPermissionFromSheet(message.author.id);
const currentCharacter = await characterService.getCharacterByUserId(message.author.id);

if (!userPermission || !currentCharacter) {
    // 자동 가입 로직 실행
}
```

**사용자 정보 수집**
```javascript
const userId = message.author.id;
const discordNickname = message.author.displayName || message.author.username;
const discordTag = `${message.author.username}#${message.author.discriminator}`;
```

**계정 생성**
```javascript
const createResult = await characterService.createNewCharacter(
    newCharacterName,  // 사용자가 입력한 새 캐릭터명
    userId,
    discordNickname,
    discordTag,
    '일반길드원'       // 기본 권한
);
```

### 2. 사용자 피드백 개선

**가입 완료 메시지**
- Discord Embed 형태로 가입 정보 표시
- 사용자명, 캐릭터명, 권한, 가입일시 포함
- 추가 기능 사용 가능 안내

**에러 처리**
- 중복 캐릭터명 감지 및 안내
- 캐릭터명 유효성 검사 실패 처리
- 명확한 해결 방안 제시

### 3. 기존 사용자 로직 유지

**기존 등록 사용자**
- 기존 닉네임 변경 로직 그대로 유지
- 중복 캐릭터명 확인 및 사용자 승인 프로세스
- 부주 시스템 지원

## 🚀 사용자 시나리오

### 시나리오 1: 신규 사용자 자동 가입
```
사용자: !닉네임변경 전사123
봇: ⏳ 새로운 사용자를 등록하는 중...
봇: 🎉 길드 가입 및 캐릭터 등록 완료!
    👤 Discord 사용자: 홍길동 (hong#1234)
    🎮 등록된 캐릭터: 전사123
    👑 권한: 일반길드원
    📅 가입일시: 2025-09-21 14:30:15
    이제 모든 봇 기능을 사용할 수 있습니다!
```

### 시나리오 2: 기존 사용자 닉네임 변경
```
사용자: !닉네임변경 마법사456
봇: ⏳ 캐릭터명을 변경하는 중...
봇: ✅ 캐릭터명 변경 완료!
    이전 캐릭터명: 전사123
    새 캐릭터명: 마법사456
    변경일시: 2025-09-21 14:35:20
```

### 시나리오 3: 중복 캐릭터명 처리
```
사용자: !닉네임변경 기존캐릭터명
봇: ❌ "기존캐릭터명" 캐릭터명이 이미 존재합니다.
    다른 캐릭터명으로 시도해주세요.
```

## 🛡️ 보안 및 안전장치

### 1. 권한 제한
- 자동 가입 시 기본 권한: '일반길드원'
- 운영진/관리자 권한은 수동 승격 필요
- 기존 권한 체계 유지

### 2. 캐릭터명 검증
- 기존 `validateCharacterName()` 함수 활용
- 부적절한 캐릭터명 필터링
- 중복 캐릭터명 감지 및 처리

### 3. 동시성 보호
- **사용자별 잠금 시스템** 구현
- 동일 사용자의 중복 명령어 실행 방지
- 30초 타임아웃으로 데드락 방지
- 자동 만료 및 정리 시스템

### 4. 에러 처리
- 모든 실패 케이스에 대한 적절한 피드백
- 시트 연결 오류 등 시스템 오류 처리
- 사용자 가이드 및 해결 방안 제시

## 📊 데이터 구조 영향

### Google Sheets 업데이트
- **계정정보 시트**: 새 사용자 레코드 추가
- **캐릭터정보 시트**: 새 캐릭터 레코드 추가
- **길드원정보 시트**: 기존 구조 호환성 유지

### 생성되는 데이터
```
계정정보:
- 사용자ID: Discord ID
- 디스코드닉네임: displayName 또는 username
- 디스코드태그: username#discriminator
- 캐릭터명: 사용자 입력값
- 권한: '일반길드원'
- 계정유형: '본주'
- 가입일시: 자동 생성

캐릭터정보:
- 캐릭터명: 사용자 입력값
- 총점수: 0
- 생성일시: 자동 생성
- 수정일시: 자동 생성
```

## 🔧 운영 고려사항

### 1. 동시성 관리
- 사용자별 잠금으로 중복 가입 방지
- 메모리 기반 잠금 시스템 (봇 재시작 시 초기화)
- 30초 타임아웃으로 데드락 방지
- 5분마다 만료된 잠금 자동 정리

### 2. 모니터링
- 자동 가입 로그 모니터링
- 잠금 획득/해제 로그 추적
- 악용 사례 감지 시스템
- 가입 패턴 분석

### 3. 관리 효율성
- 운영진 수동 작업 감소
- 신규 가입자 즉시 봇 기능 사용 가능
- 자동화된 가입 프로세스

### 4. 확장성
- 추후 가입 승인 시스템 도입 가능
- 캐릭터명 정책 강화 가능
- 가입 시 추가 정보 수집 확장 가능

## 🎉 기대 효과

### 사용자 편의성
- 즉시 가입 및 봇 기능 사용 가능
- 운영진 대기 시간 없음
- 직관적인 가입 프로세스

### 운영진 효율성
- 수동 계정 추가 작업 감소
- 관리 부담 경감
- 더 중요한 운영 업무에 집중 가능

### 시스템 안정성
- 기존 사용자 로직 완전 보존
- 점진적 기능 전환
- 롤백 용이성

---

*문서 작성일: 2025-09-21*
*마지막 업데이트: 2025-09-21*